<div id="comments-list">
  <% commetable.comments.where(parent_id: nil).each do |comment| %>
    <div id="comment-<%= comment.id %>" class="mb-3">

      <p>
        <%= display_image_or_default(comment.user.image, width: 30, height: 30, classes: "rounded-circle me-1") %>
         <strong><%= comment.user.name %></strong>
         <i class="fa-regular fa-clock"></i>
         <%= l(comment.created_at, format: :short) %>
      </p>
      <p class="mb-2"><%= comment.body %></p>

      <div class="d-flex gap-2 align-items-center mb-2">
        <%= render 'public/comment_likes/likes', comment: comment %>
        <%= link_to "返信", "#", class: "btn btn-sm btn-outline-secondary", data: { toggle: "reply-form-#{comment.id}" } %>
        <% if comment.user == current_user %>
          <%= link_to '削除', polymorphic_path([commetable, comment]), method: :delete, data: { confirm: '削除しますか？' }, class: 'btn btn-sm btn-danger' %>
        <% end %>
      </div>

      <!-- 返信フォーム -->
      <div id="reply-form-<%= comment.id %>" style="display: none;" class="mb-2">
        <%= form_with model: [commetable, Comment.new], local: true do |f| %>
          <%= f.hidden_field :commetable_type, value: commetable.class.name %>
          <%= f.hidden_field :commetable_id, value: commetable.id %>
          <%= f.hidden_field :parent_id, value: comment.id %>
          <%= f.text_area :body, rows: 2, class: "form-control", placeholder: "返信を書く..." %>
          <%= f.submit "返信", class: "btn btn-sm btn-primary mt-1" %>
        <% end %>
      </div>

      <!-- ▼ 返信の折りたたみ部分 -->
      <% replies = comment.replies %>
      <% if replies.any? %>
        <p class="text-muted small">
           <%= replies.count %>件の返信
          <a href="#" class="toggle-replies text-primary small" data-target="replies-<%= comment.id %>">▶ 表示</a>
        </p>

        <div id="replies-<%= comment.id %>" style="display: none;" class="ms-4 border-start ps-3">
          <% replies.each do |reply| %>
            <div class="mb-2">
              <%= display_image_or_default(comment.user.image, width: 30, height: 30, classes: "rounded-circle me-1") %>
              <strong><%= reply.user.name %></strong>
              <i class="fa-regular fa-clock"></i>
              <%= l(reply.created_at, format: :short) %><br>
              <%= reply.body %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>